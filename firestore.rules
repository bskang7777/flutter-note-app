rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자별 메모 접근 권한
    match /users/{userId} {
      // 사용자는 자신의 데이터만 읽기/쓰기 가능
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // 사용자별 메모 컬렉션
      match /notes/{noteId} {
        // 인증된 사용자만 자신의 메모에 접근 가능
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // 메모 생성 시 필수 필드 검증
        allow create: if request.auth != null 
          && request.auth.uid == userId
          && request.resource.data.keys().hasAll(['content', 'createdAt'])
          && request.resource.data.content is string
          && request.resource.data.content.size() > 0
          && request.resource.data.content.size() <= 1000
          && request.resource.data.createdAt is timestamp;
        
        // 메모 수정 시 필드 검증
        allow update: if request.auth != null 
          && request.auth.uid == userId
          && request.resource.data.keys().hasAll(['content', 'createdAt'])
          && request.resource.data.content is string
          && request.resource.data.content.size() > 0
          && request.resource.data.content.size() <= 1000;
      }
    }
    
    // 다른 모든 요청은 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}